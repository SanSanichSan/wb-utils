#!/bin/sh

if [ "$1" = "configure" ]; then
    if [ ! "$2" = "" ]; then
        if `dpkg --compare-versions $2 lt 1.75.0`; then
            # the runlevels for wb-prepare and wb-gsm were different
            # prior to 1.75
            # update-rc.d remove refuses to remove symlinks for wb-prepare
            # because of dependencies, so let's help it using low-level insserv
            insserv -f -r wb-prepare
            insserv -f -r wb-gsm-rtc
        elif `dpkg --compare-versions $2 lt 1.73.1`; then
            # the runlevels for wb-gsm-rtc prior to 1.73.1 were different
            # this is necessary to clear the old symlinks. 
            # The new ones will be installed by update-rc.d below
            update-rc.d wb-gsm-rtc remove
        fi
    fi
fi

update-rc.d wb-prepare start 11 3 S . >/dev/null
invoke-rc.d wb-prepare fix_macs

update-rc.d wb-gsm-rtc start 10 3 S . stop 10 0 6 . >/dev/null

update-rc.d wb-init defaults >/dev/null
invoke-rc.d wb-init start

[ -e /var/www/uploads ] || mkdir -p /var/www/uploads
chown www-data:www-data /var/www/uploads
update-rc.d wb-watch-update defaults
invoke-rc.d wb-watch-update start

case "$1" in
install|upgrade|configure)
    wb_dir="/var/lib/wirenboard"
    short_sn_fname="$wb_dir/short_sn.conf"
    if [ ! -f "$short_sn_fname" ]; then
        echo "Reboot required for correct SN generation"
    fi
esac

